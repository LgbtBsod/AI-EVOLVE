# Отчет о новой архитектуре системы атрибутов

## Обзор

Реализована новая архитектура системы атрибутов, которая решает проблему дублирования и обеспечивает гибкое управление атрибутами игровых сущностей.

## Архитектура

### 1. Шаблоны атрибутов (JSON)
- **Файл**: `data/attributes.json`
- **Назначение**: Хранение базовых шаблонов атрибутов
- **Структура**: Каждый атрибут содержит ID, название, описание, базовые значения, скорость роста, категорию и эффекты

### 2. Менеджер шаблонов (`AttributeTemplateManager`)
- **Файл**: `core/attributes.py`
- **Назначение**: Загрузка и управление шаблонами атрибутов
- **Функции**:
  - Загрузка шаблонов из JSON
  - Создание атрибутов на основе шаблонов
  - Резервные шаблоны при ошибке загрузки

### 3. Менеджер атрибутов сущности (`AttributeManager`)
- **Файл**: `core/attributes.py`
- **Назначение**: Управление атрибутами конкретной сущности
- **Функции**:
  - Инициализация из шаблонов
  - Управление текущими значениями
  - Расчет эффектов от атрибутов
  - Сохранение/загрузка в словарь

### 4. Центральный менеджер атрибутов (`EntityAttributeManager`)
- **Файл**: `core/entity_attribute_manager.py`
- **Назначение**: Координация между шаблонами и БД
- **Функции**:
  - Создание атрибутов для новых сущностей
  - Сохранение/загрузка в SQLite БД
  - Экспорт/импорт в JSON
  - Управление прогрессом и опытом

## Преимущества новой архитектуры

### 1. Устранение дублирования
- **Раньше**: Атрибуты дублировались в `game_constants.py`, `settings_manager.py`, классах сущностей
- **Теперь**: Единый источник истины в `unified_settings.py` + шаблоны JSON

### 2. Гибкость настройки
- **Шаблоны**: Легко изменять базовые значения атрибутов
- **Индивидуальность**: Каждая сущность может иметь свои значения
- **Динамичность**: Атрибуты могут изменяться во время игры

### 3. Персистентность
- **БД**: Прогресс игроков сохраняется в SQLite
- **JSON**: Возможность экспорта/импорта для резервных копий
- **Шаблоны**: Легко создавать новые типы атрибутов

### 4. AI атрибуты как свойства сущности
- **Раньше**: `learning_rate` был константой
- **Теперь**: Каждая сущность имеет свои AI параметры
- **Гибкость**: Можно настраивать поведение ИИ индивидуально

## Структура данных

### Шаблон атрибута
```python
@dataclass
class AttributeTemplate:
    id: str                    # Уникальный идентификатор
    name: str                  # Название атрибута
    description: str           # Описание
    base_value: float          # Базовое значение
    max_value: float           # Максимальное значение
    growth_rate: float         # Скорость роста
    category: str              # Категория (physical, magical, survival, utility)
    effects: Dict[str, float]  # Эффекты от атрибута
```

### Атрибут сущности
```python
@dataclass
class Attribute:
    current: float             # Текущее значение
    maximum: float             # Максимальное значение
    growth_rate: float         # Скорость роста
    template_id: str           # Ссылка на шаблон
```

## Использование

### Создание сущности с атрибутами
```python
# Шаблоны атрибутов
player_attributes = {
    "str_001": 15.0,  # Сила
    "dex_001": 12.0,  # Ловкость
    "int_001": 18.0,  # Интеллект
    # ... другие атрибуты
}

# Создание игрока
player = Player("player_001", (100, 100), player_attributes)
```

### Управление AI атрибутами
```python
# Установка скорости обучения
player.set_ai_attribute("learning_rate", 0.25)

# Получение текущего значения
current_rate = player.learning_rate
```

### Сохранение/загрузка
```python
# Сохранение в БД
player.save_attributes()

# Загрузка из БД
player.load_attributes()
```

## База данных

### Таблица `entity_attributes`
- `id`: Первичный ключ
- `entity_id`: ID сущности
- `template_id`: ID шаблона атрибута
- `current_value`: Текущее значение
- `max_value`: Максимальное значение
- `growth_rate`: Скорость роста
- `level`: Уровень сущности
- `created_at`, `updated_at`: Временные метки

### Таблица `attribute_progress`
- `id`: Первичный ключ
- `entity_id`: ID сущности
- `attribute_points`: Очки атрибутов
- `total_experience`: Общий опыт
- `last_level_up`: Время последнего повышения уровня

## Миграция

### Автоматическая
- Существующие сущности автоматически получают стандартные атрибуты
- Обратная совместимость сохранена

### Ручная
- Можно экспортировать текущие атрибуты в JSON
- Импортировать в новую систему
- Настроить индивидуальные значения

## Тестирование

### Пример использования
```bash
python examples/attribute_system_example.py
```

### Функции демонстрации
1. Создание сущностей с атрибутами
2. Сохранение в БД
3. Загрузка из БД
4. Изменение AI атрибутов
5. Экспорт/импорт

## Заключение

Новая архитектура системы атрибутов обеспечивает:

✅ **Устранение дублирования** - единый источник истины  
✅ **Гибкость настройки** - легко изменять и создавать атрибуты  
✅ **Индивидуальность** - каждая сущность имеет свои параметры  
✅ **Персистентность** - прогресс сохраняется в БД  
✅ **AI атрибуты** - скорость обучения как свойство сущности  
✅ **Масштабируемость** - легко добавлять новые типы атрибутов  

Система готова к использованию и дальнейшему развитию.
