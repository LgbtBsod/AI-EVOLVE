# Система Атрибутов и Характеристик

## Обзор

Система атрибутов и характеристик (`AttributeSystem`) представляет собой модульную архитектуру для управления базовыми атрибутами сущностей и расчета производных характеристик. Система следует принципам единственной ответственности и обеспечивает чистую, расширяемую архитектуру.

## Архитектура

### Основные компоненты

1. **AttributeSystem** - основная система управления атрибутами
2. **StatCalculator** - калькулятор производных характеристик
3. **AttributeSet** - набор базовых атрибутов
4. **AttributeModifier** - модификаторы атрибутов
5. **StatModifier** - модификаторы характеристик

### Принципы проектирования

- **Единственная ответственность**: Каждый класс отвечает за одну конкретную задачу
- **Модульность**: Система легко расширяется и модифицируется
- **Кэширование**: Оптимизация производительности через кэширование расчетов
- **Гибкость**: Поддержка как абсолютных, так и процентных модификаторов

## Базовые атрибуты

### Определение атрибутов

```python
class BaseAttribute(Enum):
    STRENGTH = "strength"           # Сила
    AGILITY = "agility"            # Ловкость
    INTELLIGENCE = "intelligence"   # Интеллект
    VITALITY = "vitality"          # Жизненная сила
    WISDOM = "wisdom"              # Мудрость
    CHARISMA = "charisma"          # Харизма
    LUCK = "luck"                  # Удача
    ENDURANCE = "endurance"        # Выносливость
```

### Влияние атрибутов

| Атрибут | Основные влияния |
|---------|------------------|
| **Сила** | Физический урон, переносимый вес, критический урон |
| **Ловкость** | Скорость атаки, уклонение, критический удар |
| **Интеллект** | Магический урон, мана, регенерация маны |
| **Жизненная сила** | Здоровье, регенерация здоровья, стойкость |
| **Мудрость** | Сопротивление магии, регенерация маны |
| **Харизма** | Торговля, дипломатия, лидерство |
| **Удача** | Критические удары, редкие находки |
| **Выносливость** | Стамина, сопротивление усталости, стойкость |

## Производные характеристики

### Список характеристик

```python
class DerivedStat(Enum):
    HEALTH = "health"                    # Здоровье
    MANA = "mana"                        # Мана
    STAMINA = "stamina"                  # Стамина
    PHYSICAL_DAMAGE = "physical_damage"  # Физический урон
    MAGICAL_DAMAGE = "magical_damage"    # Магический урон
    DEFENSE = "defense"                  # Защита
    ATTACK_SPEED = "attack_speed"        # Скорость атаки
    SKILL_RECOVERY_SPEED = "skill_recovery_speed"  # Скорость восстановления навыков
    HEALTH_REGEN = "health_regen"        # Регенерация здоровья
    MANA_REGEN = "mana_regen"            # Регенерация маны
    STAMINA_REGEN = "stamina_regen"      # Регенерация стамины
    CRITICAL_CHANCE = "critical_chance"  # Шанс критического удара
    CRITICAL_DAMAGE = "critical_damage"  # Критический урон
    DODGE_CHANCE = "dodge_chance"        # Шанс уклонения
    BLOCK_CHANCE = "block_chance"        # Шанс блока
    MAGIC_RESISTANCE = "magic_resistance" # Сопротивление магии
    MAX_WEIGHT = "max_weight"            # Максимальный вес
    MOVEMENT_SPEED = "movement_speed"    # Скорость движения
    TOUGHNESS = "toughness"              # Стойкость
    TOUGHNESS_RECOVERY = "toughness_recovery"  # Восстановление стойкости
```

### Формулы расчета

#### Основные характеристики
- **Здоровье**: `100 + (Жизненная сила × 10) + (Сила × 2)`
- **Мана**: `50 + (Интеллект × 8) + (Мудрость × 4)`
- **Стамина**: `100 + (Выносливость × 10) + (Жизненная сила × 3)`

#### Боевые характеристики
- **Физический урон**: `10 + (Сила × 2) + (Ловкость × 1)`
- **Магический урон**: `5 + (Интеллект × 3) + (Мудрость × 1)`
- **Защита**: `5 + (Жизненная сила × 1) + (Выносливость × 1)`

#### Скоростные характеристики
- **Скорость атаки**: `1.0 + (Ловкость × 0.05) + (Сила × 0.02)`
- **Скорость восстановления навыков**: `1.0 + (Интеллект × 0.03) + (Мудрость × 0.02)`
- **Скорость движения**: `1.0 + (Ловкость × 0.03) + (Выносливость × 0.01)`

#### Регенерация
- **Регенерация здоровья**: `1.0 + (Жизненная сила × 0.5) + (Выносливость × 0.2)`
- **Регенерация маны**: `2.0 + (Интеллект × 0.4) + (Мудрость × 0.3)`
- **Регенерация стамины**: `3.0 + (Выносливость × 0.6) + (Жизненная сила × 0.2)`

#### Критические характеристики
- **Шанс критического удара**: `5% + (Ловкость × 1%) + (Удача × 2%)`
- **Критический урон**: `150% + (Сила × 5%) + (Ловкость × 3%)`

#### Защитные характеристики
- **Шанс уклонения**: `5% + (Ловкость × 1.5%) + (Удача × 1%)`
- **Шанс блока**: `5% + (Сила × 1%) + (Выносливость × 1%)`
- **Сопротивление магии**: `0% + (Мудрость × 2%) + (Интеллект × 1%)`

#### Стойкость
- **Стойкость**: `100 + (Жизненная сила × 8) + (Выносливость × 5)`
- **Восстановление стойкости**: `10 + (Выносливость × 0.8) + (Жизненная сила × 0.4)`

## Модификаторы

### Типы модификаторов

1. **Абсолютные модификаторы** - добавляют фиксированное значение
2. **Процентные модификаторы** - изменяют значение на процент

### Источники модификаторов

- Предметы (оружие, броня, аксессуары)
- Эффекты (баффы, дебаффы)
- Навыки и способности
- Временные эффекты
- Эволюционные изменения

### Примеры использования

```python
# Создание модификатора силы от меча
sword_modifier = AttributeModifier(
    modifier_id="sword_strength",
    attribute=BaseAttribute.STRENGTH,
    value=5.0,
    source="iron_sword",
    is_percentage=False
)

# Создание процентного модификатора здоровья от кольца
ring_modifier = StatModifier(
    modifier_id="ring_health",
    stat=DerivedStat.HEALTH,
    value=15.0,  # +15% к здоровью
    source="health_ring",
    is_percentage=True
)
```

## Использование системы

### Базовое использование

```python
# Создание системы атрибутов
attribute_system = AttributeSystem()

# Создание базовых атрибутов
base_attributes = AttributeSet(
    strength=15,
    agility=12,
    intelligence=10,
    vitality=14,
    wisdom=8,
    charisma=10,
    luck=10,
    endurance=12
)

# Расчет характеристик
stats = attribute_system.calculate_stats_for_entity(
    entity_id="player_1",
    base_attributes=base_attributes
)
```

### С модификаторами

```python
# Создание модификаторов
modifiers = [
    AttributeModifier("sword", BaseAttribute.STRENGTH, 5.0, "iron_sword"),
    StatModifier("ring", DerivedStat.HEALTH, 15.0, "health_ring", is_percentage=True)
]

# Расчет с модификаторами
stats = attribute_system.calculate_stats_for_entity(
    entity_id="player_1",
    base_attributes=base_attributes,
    attribute_modifiers=[modifiers[0]],
    stat_modifiers=[modifiers[1]]
)
```

## Производительность

### Кэширование

Система использует интеллектуальное кэширование для оптимизации:

- **Кэш расчетов**: Результаты расчетов кэшируются по ключу сущности и атрибутов
- **Автоочистка**: Кэш автоматически очищается каждые 60 секунд
- **Статистика**: Отслеживание попаданий и промахов кэша

### Оптимизации

- Статические методы для расчетов
- Минимальное количество обращений к базе данных
- Эффективная обработка модификаторов

## Интеграция с другими системами

### Система стойкости

Система атрибутов интегрирована с системой стойкости:
- Стойкость рассчитывается на основе атрибутов
- Модификаторы могут влиять на стойкость
- Поддержка различных типов стойкости

### Система предметов

Предметы могут предоставлять:
- Модификаторы атрибутов
- Модификаторы характеристик
- Временные эффекты

### Система навыков

Навыки могут:
- Увеличивать атрибуты
- Предоставлять временные модификаторы
- Влиять на расчет характеристик

## Расширение системы

### Добавление новых атрибутов

1. Добавить новый атрибут в `BaseAttribute`
2. Обновить `AttributeSet`
3. Добавить влияние в формулы расчета
4. Обновить `StatCalculator`

### Добавление новых характеристик

1. Добавить новую характеристику в `DerivedStat`
2. Создать метод расчета в `StatCalculator`
3. Обновить `calculate_all_stats`

### Кастомизация формул

Формулы можно легко изменять в `StatCalculator`:
- Изменение базовых значений
- Изменение множителей
- Добавление новых зависимостей

## Мониторинг и отладка

### Статистика системы

```python
info = attribute_system.get_system_info()
print(f"Расчетов: {info['stat_calculations']}")
print(f"Попаданий в кэш: {info['cache_hits']}")
print(f"Промахов кэша: {info['cache_misses']}")
```

### Логирование

Система предоставляет детальное логирование:
- Ошибки расчета
- Применение модификаторов
- Очистка кэша
- Производительность

## Заключение

Система атрибутов и характеристик обеспечивает:

- **Чистую архитектуру** с соблюдением принципов SOLID
- **Высокую производительность** через кэширование
- **Гибкость** для расширения и модификации
- **Интеграцию** с другими системами игры
- **Мониторинг** и отладку

Система готова к использованию в продакшене и может быть легко расширена для новых требований.
